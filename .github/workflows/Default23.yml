name: Build OpenWrt for TP-Link AX80 V1 (GitHub Hosted)

permissions:
  contents: write
  actions: read

on:
  push:
    branches:
      - main
    paths:
      - "*.config"
      - "files/**"
      - ".github/workflows/build-openwrt.yaml"
  workflow_dispatch:
    inputs:
      remote_ref:
        description: "Override upstream ref (optional)"
        required: false
        default: ""
  schedule:
    - cron: "38 1 * * *"  # Ночное время (меньше нагрузка)

concurrency:
  group: openwrt-build-${{ github.ref }}
  cancel-in-progress: true  # Отменяем предыдущие сборки

env:
  DL_CACHE_VERSION: v1
  ARTIFACT_RETENTION_DAYS: 7  # Уменьшаем retention
  CONFIG_FILE: build.config
  REMOTE_REPOSITORY: openwrt/openwrt
  REMOTE_REF: main
  RELEASE_PREFIX: ax80-v1
  ARTIFACT_PREFIX: ax80-v1

jobs:
  build:
    name: Build TP-Link AX80 V1 Firmware
    runs-on: ubuntu-22.04  # Используем конкретную версию
    timeout-minutes: 360   # 6 часов максимум

    steps:
      # ===================================
      # 1. ОЧИСТКА И ПОДГОТОВКА СИСТЕМЫ
      # ===================================
      
      - name: Free up disk space
        run: |
          echo "=== Освобождение дискового пространства ==="
          df -h
          
          # Удаляем ненужные системные пакеты
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo apt-get clean
          
          echo "После очистки:"
          df -h

      - name: Checkout builder repository
        uses: actions/checkout@v4
        with:
          path: builder
          
      - name: Install build dependencies
        run: |
          echo "=== Установка зависимостей ==="
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gettext \
            git \
            libncurses-dev \
            libssl-dev \
            python3 \
            python3-setuptools \
            rsync \
            swig \
            unzip \
            zlib1g-dev \
            file \
            wget \
            ccache \
            libelf-dev \
            upx-ucl

      # ===================================
      # 2. ПОЛУЧЕНИЕ ИСХОДНОГО КОДА OPENWRT
      # ===================================
      
      - name: Fetch upstream OpenWrt source
        id: upstream
        run: |
          set -euo pipefail
          
          echo "=== Получение исходного кода OpenWrt ==="
          
          # Используем shallow clone для экономии места
          REF="${{ env.REMOTE_REF }}"
          if [ -n "${{ github.event.inputs.remote_ref }}" ]; then
            REF="${{ github.event.inputs.remote_ref }}"
          fi
          
          echo "Клонируем OpenWrt (ветка: $REF)"
          git clone --depth=1 --filter=blob:none --single-branch \
            --branch "$REF" \
            https://github.com/${{ env.REMOTE_REPOSITORY }}.git openwrt
          
          cd openwrt
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "commit=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          
          echo "✓ Исходный код получен: $(git rev-parse --short HEAD)"
          du -sh .

      # ===================================
      # 3. КЭШИРОВАНИЕ (ОПТИМИЗИРОВАННОЕ)
      # ===================================
      
      - name: Restore feeds cache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/feeds
            openwrt/.feeds_updated
          key: feeds-${{ runner.os }}-${{ hashFiles('openwrt/feeds.conf.default') }}-${{ github.sha }}
          restore-keys: |
            feeds-${{ runner.os }}-${{ hashFiles('openwrt/feeds.conf.default') }}-
            feeds-${{ runner.os }}-

      - name: Restore downloads cache
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: openwrt-dl-${{ runner.os }}-${{ env.DL_CACHE_VERSION }}-${{ hashFiles('builder/ax80-v1.config') }}
          restore-keys: |
            openwrt-dl-${{ runner.os }}-${{ env.DL_CACHE_VERSION }}-
            openwrt-dl-${{ runner.os }}-

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-ax80-v1-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-ax80-v1-

      # ===================================
      # 4. ОБНОВЛЕНИЕ FEEDS (ОПТИМИЗИРОВАННОЕ)
      # ===================================
      
      - name: Update and install feeds
        run: |
          cd openwrt
          
          echo "=== Обновление feeds ==="
          echo "Диск перед обновлением:"
          df -h .
          
          # Быстрое обновление если есть кэш
          if [ -f .feeds_updated ]; then
            echo "Используем кэшированные feeds, быстрое обновление..."
            timeout 300 ./scripts/feeds update -a || true
          else
            echo "Полное обновление feeds..."
            for attempt in {1..3}; do
              echo "Попытка $attempt/3"
              if timeout 400 ./scripts/feeds update -a; then
                touch .feeds_updated
                break
              elif [ $attempt -eq 3 ]; then
                echo "::error::Не удалось обновить feeds"
                exit 1
              fi
              sleep 10
            done
          fi
          
          echo "=== Установка feeds ==="
          ./scripts/feeds install -a
          
          echo "Диск после обновления:"
          df -h .

      # ===================================
      # 5. КОНФИГУРАЦИЯ СБОРКИ
      # ===================================
      
      - name: Prepare configuration
        run: |
          cd openwrt
          
          echo "=== Подготовка конфигурации ==="
          
          # Копируем файлы overlay
          mkdir -p files
          cp -a ../builder/files/. ./files/ 2>/dev/null || true
          
          # Копируем конфиг
          cp ../builder/${{ env.CONFIG_FILE }} .config
          
          # Добавляем оптимизации для GitHub runners
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_BUILD_LOG=y" >> .config
          
          # Минимальная конфигурация
          make defconfig
          
          echo "✓ Конфигурация готова"

      # ===================================
      # 6. ЗАГРУЗКА ИСХОДНИКОВ
      # ===================================
      
      - name: Download sources
        run: |
          cd openwrt
          
          echo "=== Загрузка исходников ==="
          echo "Диск перед загрузкой:"
          df -h .
          
          # Последовательная загрузка для надежности
          for attempt in {1..2}; do
            echo "Попытка загрузки $attempt/2"
            if make download -j2 V=s; then
              echo "✓ Загрузка успешна"
              break
            elif [ $attempt -eq 2 ]; then
              echo "::error::Не удалось загрузить исходники"
              exit 1
            fi
            sleep 5
          done
          
          echo "Размер dl директории:"
          du -sh dl/ || true
          echo "Диск после загрузки:"
          df -h .

      # ===================================
      # 7. СБОРКА ПРОШИВКИ (ОПТИМИЗИРОВАННАЯ)
      # ===================================
      
      - name: Build firmware
        env:
          CCACHE_DIR: ~/.ccache
          FORCE_UNSAFE_CONFIGURE: 1
        run: |
          cd openwrt
          
          echo "=== Старт сборки ==="
          echo "Доступные ресурсы:"
          df -h .
          nproc
          free -h
          
          # Адаптивный параллелизм based on available resources
          CORES=$(nproc)
          if [ $CORES -gt 4 ]; then
            BUILD_JOBS=$((CORES - 2))  # Оставляем 2 ядра системе
          else
            BUILD_JOBS=$CORES
          fi
          
          echo "Используем $BUILD_JOBS параллельных задач"
          
          # Мониторинг диска во время сборки
          while sleep 300; do
            echo "=== Мониторинг диска ==="
            df -h . | tail -1
          done &
          MONITOR_PID=$!
          
          # Стратегия сборки с fallback
          if ! make -j${BUILD_JOBS} V=w; then
            echo "::warning::Параллельная сборка не удалась, пробуем с меньшим параллелизмом"
            
            # Очистка временных файлов
            find build_dir -name "*.o" -delete 2>/dev/null || true
            
            if ! make -j2 V=w; then
              echo "::error::Сборка не удалась"
              # Сохраняем логи для диагностики
              tail -50 logs/*.log 2>/dev/null || true
              kill $MONITOR_PID 2>/dev/null || true
              exit 1
            fi
          fi
          
          kill $MONITOR_PID 2>/dev/null || true
          echo "✓ Сборка завершена успешно"

      # ===================================
      # 8. СОБИРАЕМ АРТЕФАКТЫ
      # ===================================
      
      - name: Collect firmware artifacts
        run: |
          cd openwrt
          
          echo "=== Сбор артефактов ==="
          
          ART_DIR="artifacts/ax80-v1"
          mkdir -p "$ART_DIR"
          
          # Копируем только необходимые файлы
          find bin/targets -type f \( \
            -name '*-sysupgrade.bin' -o \
            -name '*-factory.bin' -o \
            -name 'sha256sums' -o \
            -name '*.buildinfo' \
          \) -exec cp {} "$ART_DIR/" \;
          
          # Конфиг сборки
          cp .config "$ART_DIR/full.config"
          
          # Генерируем checksums
          (cd "$ART_DIR" && sha256sum *.bin > sha256sums.txt 2>/dev/null || true)
          
          # Информация о сборке
          {
            echo "Build: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Repo: ${{ github.repository }}"
            echo "Commit: ${{ github.sha }}"
            echo "OpenWrt: ${{ steps.upstream.outputs.ref }}@${{ steps.upstream.outputs.short }}"
            echo "Files:"
            ls -la "$ART_DIR"/*.bin 2>/dev/null || echo "No firmware files"
          } > "$ART_DIR/build-info.txt"
          
          echo "=== Результаты ==="
          ls -la "$ART_DIR/"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_PREFIX }}-firmware
          path: openwrt/artifacts/ax80-v1
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          compression-level: 9  # Максимальное сжатие

      # ===================================
      # 9. СОЗДАНИЕ РЕЛИЗА
      # ===================================
      
      - name: Prepare release
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        id: release
        run: |
          tag="${{ env.RELEASE_PREFIX }}-$(date +%Y%m%d)"
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"
          
          cat > release-info.md << EOF
          ### TP-Link Archer AX80 V1 - OpenWrt Build
          
          **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Source:** ${{ env.REMOTE_REPOSITORY }}@${{ steps.upstream.outputs.ref }}
          **Commit:** ${{ steps.upstream.outputs.short }}
          
          **Installation:**
          - \`factory.bin\` - для установки из stock прошивки
          - \`sysupgrade.bin\` - для обновления существующего OpenWrt
          
          **Features:**
          - Wi-Fi 6 (802.11ax) support
          - LuCI web interface
          - WireGuard VPN
          - SQM QoS
          
          Built via GitHub Actions
          EOF

      - name: Create release
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release.outputs.release_tag }}
          name: "AX80 V1 Build ${{ steps.release.outputs.release_tag }}"
          body_path: release-info.md
          files: openwrt/artifacts/ax80-v1/*
          draft: false
          prerelease: false

      # ===================================
      # 10. ОЧИСТКА
      # ===================================
      
      - name: Cleanup workspace
        if: always()
        run: |
          echo "=== Финальная очистка ==="
          df -h
          echo "Workflow завершен"
