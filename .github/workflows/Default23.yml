name: Build OpenWrt for TP-Link AX80 V1 (GitHub Hosted)

permissions:
  contents: write
  actions: read

on:
  push:
    branches:
      - main
    paths:
      - "*.config"
      - "files/**"
      - ".github/workflows/build-openwrt.yaml"
  workflow_dispatch:
    inputs:
      remote_ref:
        description: "Override upstream ref (optional)"
        required: false
        default: ""
      test_pr:
        description: "Test specific PR number (e.g., 19440)"
        required: false
        default: ""
  schedule:
    - cron: "38 1 * * *"

concurrency:
  group: openwrt-build-${{ github.ref }}-${{ github.event.inputs.test_pr || 'main' }}
  cancel-in-progress: true

env:
  DL_CACHE_VERSION: v1
  ARTIFACT_RETENTION_DAYS: 7
  CONFIG_FILE: ax80-v1.config
  REMOTE_REPOSITORY: openwrt/openwrt
  REMOTE_REF: main
  RELEASE_PREFIX: ax80-v1
  ARTIFACT_PREFIX: ax80-v1

jobs:
  build:
    name: Build TP-Link AX80 V1 Firmware
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      # ===================================
      # 1. ОЧИСТКА И ПОДГОТОВКА СИСТЕМЫ
      # ===================================
      
      - name: Free up disk space
        run: |
          echo "=== Освобождение дискового пространства ==="
          df -h
          
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo apt-get clean
          
          echo "После очистки:"
          df -h

      - name: Checkout builder repository
        uses: actions/checkout@v4
        with:
          path: builder

      - name: Install build dependencies
        run: |
          echo "=== Установка зависимостей ==="
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gettext \
            git \
            libncurses-dev \
            libssl-dev \
            python3 \
            python3-setuptools \
            rsync \
            swig \
            unzip \
            zlib1g-dev \
            file \
            wget \
            ccache \
            libelf-dev \
            upx-ucl

      # ===================================
      # 2. ПОЛУЧЕНИЕ ИСХОДНОГО КОДА OPENWRT
      # ===================================
      
      - name: Fetch upstream OpenWrt source
        id: upstream
        run: |
          set -euo pipefail
          
          echo "=== Получение исходного кода OpenWrt ==="
          
          # Используем shallow clone для экономии места
          REF="${{ env.REMOTE_REF }}"
          if [ -n "${{ github.event.inputs.remote_ref }}" ]; then
            REF="${{ github.event.inputs.remote_ref }}"
          fi
          
          echo "Клонируем OpenWrt (ветка: $REF)"
          git clone --depth=1 --filter=blob:none --single-branch \
            --branch "$REF" \
            https://github.com/${{ env.REMOTE_REPOSITORY }}.git openwrt
          
          cd openwrt
          
          # Если указан PR для тестирования - мержим его
          if [ -n "${{ github.event.inputs.test_pr }}" ]; then
            PR_NUMBER="${{ github.event.inputs.test_pr }}"
            echo "=== Тестируем PR #$PR_NUMBER ==="
            
            # Получаем и мержим PR
            git fetch origin "pull/$PR_NUMBER/head:pr-$PR_NUMBER"
            git checkout "pr-$PR_NUMBER"
            
            # Получаем информацию о PR
            PR_INFO=$(curl -s "https://api.github.com/repos/${{ env.REMOTE_REPOSITORY }}/pulls/$PR_NUMBER")
            PR_TITLE=$(echo "$PR_INFO" | grep '"title":' | head -1 | cut -d'"' -f4)
            PR_AUTHOR=$(echo "$PR_INFO" | grep '"login":' | head -1 | cut -d'"' -f4)
            
            echo "PR Title: $PR_TITLE"
            echo "PR Author: $PR_AUTHOR"
            echo "PR Branch: pr-$PR_NUMBER"
            
            # Обновляем вывод с информацией о PR
            echo "ref=$REF" >> "$GITHUB_OUTPUT"
            echo "commit=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
            echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            echo "pr_title=$PR_TITLE" >> "$GITHUB_OUTPUT"
            echo "pr_author=$PR_AUTHOR" >> "$GITHUB_OUTPUT"
          else
            # Стандартная информация о коммите
            echo "ref=$REF" >> "$GITHUB_OUTPUT"
            echo "commit=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
            echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
            echo "pr_number=" >> "$GITHUB_OUTPUT"
            echo "pr_title=" >> "$GITHUB_OUTPUT"
            echo "pr_author=" >> "$GITHUB_OUTPUT"
          fi
          
          echo "✓ Исходный код получен: $(git rev-parse --short HEAD)"
          du -sh .

      # ===================================
      # 3. КЭШИРОВАНИЕ (С УЧЕТОМ PR)
      # ===================================
      
      - name: Restore feeds cache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/feeds
            openwrt/.feeds_updated
          key: feeds-${{ runner.os }}-${{ hashFiles('openwrt/feeds.conf.default') }}-${{ github.sha }}-${{ steps.upstream.outputs.pr_number || 'main' }}
          restore-keys: |
            feeds-${{ runner.os }}-${{ hashFiles('openwrt/feeds.conf.default') }}-
            feeds-${{ runner.os }}-

      - name: Restore downloads cache
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: openwrt-dl-${{ runner.os }}-${{ env.DL_CACHE_VERSION }}-${{ hashFiles('builder/ax80-v1.config') }}-${{ steps.upstream.outputs.pr_number || 'main' }}
          restore-keys: |
            openwrt-dl-${{ runner.os }}-${{ env.DL_CACHE_VERSION }}-
            openwrt-dl-${{ runner.os }}-

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-ax80-v1-${{ github.sha }}-${{ steps.upstream.outputs.pr_number || 'main' }}
          restore-keys: |
            ccache-${{ runner.os }}-ax80-v1-

      # ===================================
      # 4. ОБНОВЛЕНИЕ FEEDS
      # ===================================
      
      - name: Update and install feeds
        run: |
          cd openwrt
          
          echo "=== Обновление feeds ==="
          echo "Диск перед обновлением:"
          df -h .
          
          # Проверяем, тестируем ли мы PR (может влиять на feeds)
          if [ -n "${{ steps.upstream.outputs.pr_number }}" ]; then
            echo "⚠️  Тестируем PR, принудительно обновляем feeds..."
            rm -f .feeds_updated
          fi
          
          # Быстрое обновление если есть кэш
          if [ -f .feeds_updated ]; then
            echo "Используем кэшированные feeds, быстрое обновление..."
            timeout 300 ./scripts/feeds update -a || true
          else
            echo "Полное обновление feeds..."
            for attempt in {1..3}; do
              echo "Попытка $attempt/3"
              if timeout 400 ./scripts/feeds update -a; then
                touch .feeds_updated
                break
              elif [ $attempt -eq 3 ]; then
                echo "::error::Не удалось обновить feeds"
                exit 1
              fi
              sleep 10
            done
          fi
          
          echo "=== Установка feeds ==="
          ./scripts/feeds install -a
          
          echo "Диск после обновления:"
          df -h .

      # ===================================
      # 5. КОНФИГУРАЦИЯ СБОРКИ
      # ===================================
      
      - name: Prepare configuration
        run: |
          cd openwrt
          
          echo "=== Подготовка конфигурации ==="
          
          # Проверяем существование конфига
          if [ ! -f "../builder/${{ env.CONFIG_FILE }}" ]; then
            echo "::error::Конфигурационный файл ../builder/${{ env.CONFIG_FILE }} не найден"
            ls -la ../builder/
            exit 1
          fi
          
          # Копируем файлы overlay если есть
          if [ -d "../builder/files" ]; then
            echo "Копируем файлы overlay..."
            mkdir -p files
            cp -a ../builder/files/. ./files/
          fi
          
          # Копируем конфиг
          cp "../builder/${{ env.CONFIG_FILE }}" .config
          
          # Добавляем оптимизации
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_BUILD_LOG=y" >> .config
          
          # Минимальная конфигурация
          make defconfig
          
          echo "✓ Конфигурация готова"

      # ===================================
      # 6. ЗАГРУЗКА ИСХОДНИКОВ
      # ===================================
      
      - name: Download sources
        run: |
          cd openwrt
          
          echo "=== Загрузка исходников ==="
          echo "Диск перед загрузкой:"
          df -h .
          
          # Последовательная загрузка для надежности
          for attempt in {1..2}; do
            echo "Попытка загрузки $attempt/2"
            if make download -j2 V=s; then
              echo "✓ Загрузка успешна"
              break
            elif [ $attempt -eq 2 ]; then
              echo "::error::Не удалось загрузить исходники"
              exit 1
            fi
            sleep 5
          done
          
          echo "Размер dl директории:"
          du -sh dl/ || true
          echo "Диск после загрузки:"
          df -h .

      # ===================================
      # 7. СБОРКА ПРОШИВКИ
      # ===================================
      
      - name: Build firmware
        env:
          CCACHE_DIR: ~/.ccache
          FORCE_UNSAFE_CONFIGURE: 1
        run: |
          cd openwrt
          
          echo "=== Старт сборки ==="
          echo "Доступные ресурсы:"
          df -h .
          echo "Ядер: $(nproc)"
          free -h
          
          # Адаптивный параллелизм
          CORES=$(nproc)
          if [ $CORES -gt 4 ]; then
            BUILD_JOBS=$((CORES - 2))
          else
            BUILD_JOBS=$CORES
          fi
          
          echo "Используем $BUILD_JOBS параллельных задач"
          
          # Мониторинг диска в фоне
          while sleep 300; do
            echo "=== Мониторинг диска ==="
            df -h . | tail -1
          done &
          MONITOR_PID=$!
          
          # Стратегия сборки с fallback
          if ! make -j${BUILD_JOBS} V=w; then
            echo "::warning::Параллельная сборка не удалась, пробуем с меньшим параллелизмом"
            
            # Очистка временных файлов
            find build_dir -name "*.o" -delete 2>/dev/null || true
            
            if ! make -j2 V=w; then
              echo "::error::Сборка не удалась"
              # Сохраняем логи для диагностики
              echo "=== Последние логи ==="
              tail -100 logs/*.log 2>/dev/null || true
              kill $MONITOR_PID 2>/dev/null || true
              exit 1
            fi
          fi
          
          kill $MONITOR_PID 2>/dev/null || true
          echo "✓ Сборка завершена успешно"

      # ===================================
      # 8. СОБИРАЕМ АРТЕФАКТЫ
      # ===================================
      
      - name: Collect firmware artifacts
        run: |
          cd openwrt
          
          echo "=== Сбор артефактов ==="
          
          # Определяем имя директории на основе PR
          if [ -n "${{ steps.upstream.outputs.pr_number }}" ]; then
            ART_DIR="artifacts/ax80-v1-pr-${{ steps.upstream.outputs.pr_number }}"
          else
            ART_DIR="artifacts/ax80-v1"
          fi
          
          mkdir -p "$ART_DIR"
          
          # Ищем файлы прошивок
          FIRMWARE_FILES=$(find bin/targets -type f \( -name '*-sysupgrade.bin' -o -name '*-factory.bin' \) 2>/dev/null || true)
          
          if [ -z "$FIRMWARE_FILES" ]; then
            echo "::warning::Файлы прошивок не найдены, ищем альтернативы..."
            find bin/targets -type f -name '*.bin' || true
            find bin -type f -name '*.bin' || true
          else
            echo "Найдены файлы прошивок:"
            echo "$FIRMWARE_FILES"
            echo "$FIRMWARE_FILES" | xargs -I {} cp {} "$ART_DIR/" 2>/dev/null || true
          fi
          
          # Копируем дополнительные файлы
          cp .config "$ART_DIR/full.config" 2>/dev/null || true
          find bin -name 'sha256sums' -exec cp {} "$ART_DIR/" \; 2>/dev/null || true
          find bin -name '*.buildinfo' -exec cp {} "$ART_DIR/" \; 2>/dev/null || true
          
          # Генерируем checksums если есть bin файлы
          if ls "$ART_DIR"/*.bin >/dev/null 2>&1; then
            (cd "$ART_DIR" && sha256sum *.bin > sha256sums.txt)
            echo "✓ Checksums сгенерированы"
          fi
          
          # Информация о сборке
          {
            echo "Build: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Repo: ${{ github.repository }}"
            echo "Commit: ${{ github.sha }}"
            echo "OpenWrt: ${{ steps.upstream.outputs.ref }}@${{ steps.upstream.outputs.short }}"
            if [ -n "${{ steps.upstream.outputs.pr_number }}" ]; then
              echo "PR: #${{ steps.upstream.outputs.pr_number }} - ${{ steps.upstream.outputs.pr_title }}"
              echo "PR Author: ${{ steps.upstream.outputs.pr_author }}"
            fi
            echo "Files:"
            ls -la "$ART_DIR/" 2>/dev/null || echo "No files found"
          } > "$ART_DIR/build-info.txt"
          
          echo "=== Результаты ==="
          ls -la "$ART_DIR/" 2>/dev/null || echo "Артефакты не созданы"

      - name: Upload firmware artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_PREFIX }}${{ steps.upstream.outputs.pr_number && format('-pr-{0}', steps.upstream.outputs.pr_number) || '' }}-firmware
          path: openwrt/artifacts/ax80-v1${{ steps.upstream.outputs.pr_number && format('-pr-{0}', steps.upstream.outputs.pr_number) || '' }}
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          compression-level: 9

      # ===================================
      # 9. СОЗДАНИЕ РЕЛИЗА
      # ===================================
      
      - name: Prepare release
        if: (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && success()
        id: release
        run: |
          if [ -n "${{ steps.upstream.outputs.pr_number }}" ]; then
            tag="${{ env.RELEASE_PREFIX }}-pr-${{ steps.upstream.outputs.pr_number }}-$(date +%Y%m%d)"
            name="AX80 V1 PR ${{ steps.upstream.outputs.pr_number }} Build $(date +%Y%m%d)"
          else
            tag="${{ env.RELEASE_PREFIX }}-$(date +%Y%m%d)"
            name="AX80 V1 Build $(date +%Y%m%d)"
          fi
          
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"
          echo "release_name=$name" >> "$GITHUB_OUTPUT"
          
          # Создаем описание релиза
          if [ -n "${{ steps.upstream.outputs.pr_number }}" ]; then
            cat > release-info.md << EOF
          ### TP-Link Archer AX80 V1 - OpenWrt Build with PR #${{ steps.upstream.outputs.pr_number }}
          
          **PR Title:** ${{ steps.upstream.outputs.pr_title }}
          **PR Author:** ${{ steps.upstream.outputs.pr_author }}
          **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          **Source:** ${{ env.REMOTE_REPOSITORY }}@${{ steps.upstream.outputs.ref }}
          **Commit:** ${{ steps.upstream.outputs.short }}
          
          **Installation:**
          - \`factory.bin\` - для установки из stock прошивки
          - \`sysupgrade.bin\` - для обновления существующего OpenWrt
          
          **⚠️  Это тестовая сборка с PR!**
          Используйте с осторожностью, возможны нестабильности.
          
          Built via GitHub Actions
          EOF
          else
            cat > release-info.md << EOF
          ### TP-Link Archer AX80 V1 - OpenWrt Build
          
          **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Source:** ${{ env.REMOTE_REPOSITORY }}@${{ steps.upstream.outputs.ref }}
          **Commit:** ${{ steps.upstream.outputs.short }}
          
          **Installation:**
          - \`factory.bin\` - для установки из stock прошивки
          - \`sysupgrade.bin\` - для обновления существующего OpenWrt
          
          **Features:**
          - Wi-Fi 6 (802.11ax) support
          - LuCI web interface
          - WireGuard VPN
          - SQM QoS
          
          Built via GitHub Actions
          EOF
          fi

      - name: Create release
        if: (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release.outputs.release_tag }}
          name: ${{ steps.release.outputs.release_name }}
          body_path: release-info.md
          files: openwrt/artifacts/ax80-v1${{ steps.upstream.outputs.pr_number && format('-pr-{0}', steps.upstream.outputs.pr_number) || '' }}/*
          draft: false
          prerelease: ${{ steps.upstream.outputs.pr_number != '' }}

      # ===================================
      # 10. ФИНАЛЬНАЯ СТАТИСТИКА
      # ===================================
      
      - name: Final stats
        if: always()
        run: |
          echo "=== Финальная статистика ==="
          df -h
          echo "Workflow завершен со статусом: ${{ job.status }}"
          if [ -n "${{ steps.upstream.outputs.pr_number }}" ]; then
            echo "Тестировался PR: #${{ steps.upstream.outputs.pr_number }}"
          fi
