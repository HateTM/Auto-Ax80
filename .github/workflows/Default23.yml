name: Build OpenWrt for TP-Link AX80 V1

permissions:
  contents: write
  actions: read

on:
  push:
    branches:
      - main
    paths:
      - "*.config"
      - "files/**"
      - ".github/workflows/build-openwrt.yaml"
  workflow_dispatch:
    inputs:
      remote_ref:
        description: "Override upstream ref (optional)"
        required: false
        default: ""
  schedule:
    - cron: "38 1 * * *"

concurrency:
  group: openwrt-build-${{ github.ref }}
  cancel-in-progress: false

env:
  DL_CACHE_VERSION: v1
  ARTIFACT_RETENTION_DAYS: 10
  CONFIG_FILE: ax80-v1.config
  REMOTE_REPOSITORY: openwrt/openwrt
  REMOTE_REF: main
  RELEASE_PREFIX: ax80-v1
  ARTIFACT_PREFIX: ax80-v1

jobs:
  build:
    name: Build TP-Link AX80 V1 Firmware
    runs-on: self-hosted
    timeout-minutes: 480

    steps:
      # ===================================
      # 1. PREPARATION AND CLEANUP
      # ===================================
      
      - name: Cleanup workspace
        run: |
          echo "=== Workspace Cleanup ==="
          echo "Current directory: $PWD"
          df -h . | tail -1
          
          # Remove old build artifacts but preserve caches
          rm -rf openwrt builder 2>/dev/null || true
          find . -name '*.lock' -delete 2>/dev/null || true
          
          echo "Disk space after cleanup:"
          df -h . | tail -1

      - name: Checkout builder repository
        uses: actions/checkout@v4
        with:
          path: builder

      - name: Verify build dependencies
        run: |
          echo "=== Checking Build Dependencies ==="
          missing=()
          for cmd in git gcc g++ make gawk wget unzip python3 rsync flex bison swig ccache; do
            command -v $cmd >/dev/null || missing+=("$cmd")
          done
          
          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing dependencies: ${missing[*]}"
            if command -v apt >/dev/null 2>&1; then
              echo "Installing dependencies via apt..."
              sudo apt update -qq
              sudo apt install -y build-essential clang flex bison g++ gawk gettext \
                libncurses-dev libssl-dev python3-setuptools rsync swig unzip \
                zlib1g-dev file wget llvm ccache libelf-dev
            else
              echo "::error::Missing dependencies and apt not available"
              exit 1
            fi
          else
            echo "✓ All required dependencies present"
          fi

      # ===================================
      # 2. FETCH OPENWRT SOURCE
      # ===================================
      
      - name: Fetch upstream OpenWrt source
        id: upstream
        run: |
          set -euo pipefail
          
          echo "=== Fetching OpenWrt Source ==="
          
          # Clean up any existing directory
          if [ -d "openwrt" ]; then
            echo "Removing existing openwrt directory..."
            rm -rf openwrt
          fi
          
          # Determine ref to clone
          REF="${{ env.REMOTE_REF }}"
          if [ "$REF" = "auto-next" ]; then
            REF=$(git ls-remote https://github.com/${{ env.REMOTE_REPOSITORY }}.git "refs/heads/next-*" \
              | grep -vi 'test' \
              | awk '{print $2}' \
              | sed 's|refs/heads/||' \
              | sort -V \
              | tail -n1)
          fi
          
          # Allow override from workflow dispatch
          if [ -n "${{ github.event.inputs.remote_ref }}" ]; then
            REF="${{ github.event.inputs.remote_ref }}"
          fi
          
          if [ -z "$REF" ]; then
            echo "::error::Unable to determine upstream ref"
            exit 1
          fi
          
          # Clone repository
          echo "Cloning OpenWrt from ${{ env.REMOTE_REPOSITORY }} (ref: $REF)"
          git clone --depth=1 --filter=blob:none --single-branch \
            --branch "$REF" \
            https://github.com/${{ env.REMOTE_REPOSITORY }}.git openwrt
          
          cd openwrt
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "commit=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "✓ OpenWrt source fetched: $(git rev-parse --short HEAD)"

      # ===================================
      # 3. RESTORE CACHES
      # ===================================
      
      - name: Restore feeds cache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/feeds
            openwrt/.feeds_updated
          key: feeds-${{ hashFiles('openwrt/feeds.conf.default') }}-${{ github.sha }}
          restore-keys: |
            feeds-${{ hashFiles('openwrt/feeds.conf.default') }}-
            feeds-

      - name: Restore downloads cache
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: openwrt-dl-${{ env.DL_CACHE_VERSION }}-${{ hashFiles('builder/ax80-v1.config') }}
          restore-keys: |
            openwrt-dl-${{ env.DL_CACHE_VERSION }}-

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-ax80-v1-${{ github.sha }}
          restore-keys: |
            ccache-ax80-v1-

      - name: Restore toolchain cache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: toolchain-ax80-v1-${{ hashFiles('builder/ax80-v1.config') }}
          restore-keys: |
            toolchain-ax80-v1-

      # ===================================
      # 4. UPDATE FEEDS
      # ===================================
      
      - name: Update and install feeds
        run: |
          cd openwrt
          
          echo "=== Updating Feeds ==="
          
          # Configure git for better reliability
          git config --global http.postBuffer 1048576000
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 300
          git config --global core.compression 0
          git config --global protocol.version 2
          
          # Check if feeds are already current from cache
          if [ -f .feeds_updated ]; then
            echo "Using cached feeds, attempting quick update..."
            if ! ./scripts/feeds update -a; then
              echo "Cached feeds update failed, forcing fresh clone..."
              rm -rf feeds .feeds_updated
            fi
          fi
          
          # Update feeds with robust retry logic
          if [ ! -f .feeds_updated ]; then
            for attempt in {1..5}; do
              echo "Attempt $attempt/5: Updating feeds..."
              
              if timeout 600 ./scripts/feeds update -a; then
                echo "✓ Feeds updated successfully"
                touch .feeds_updated
                break
              else
                EXIT_CODE=$?
                echo "Feed update failed (exit code: $EXIT_CODE)"
                
                if [ $attempt -lt 5 ]; then
                  echo "Retrying in 15 seconds..."
                  sleep 15
                  # Clean up partial clones
                  find feeds -name '*.git/index.lock' -delete 2>/dev/null || true
                else
                  echo "::error::Failed to update feeds after 5 attempts"
                  exit 1
                fi
              fi
            done
          fi
          
          # Install feeds with retry
          echo "=== Installing Feeds ==="
          for attempt in {1..2}; do
            if ./scripts/feeds install -a; then
              echo "✓ Feeds installed successfully"
              break
            else
              if [ $attempt -eq 1 ]; then
                echo "First feed install failed, retrying..."
                sleep 5
              else
                echo "::error::Feed installation failed"
                exit 1
              fi
            fi
          done

      # ===================================
      # 5. PREPARE CONFIGURATION
      # ===================================
      
      - name: Prepare configuration and overlay
        run: |
          cd openwrt
          
          echo "=== Preparing Configuration ==="
          
          # Copy custom file overlay
          mkdir -p files
          cp -a ../builder/files/. ./files/
          
          # Update upgrade script with repository info
          if [ -f ./files/usr/bin/upgrade_custom_openwrt ]; then
            sed -i "s|XXXXXX/XXXXXX|${{ github.repository }}|" ./files/usr/bin/upgrade_custom_openwrt || true
            chmod 755 ./files/usr/bin/upgrade_custom_openwrt
            echo "✓ Updated upgrade script"
          fi
          
          # Copy and expand configuration
          cp ../builder/${{ env.CONFIG_FILE }} .config
          echo "CONFIG_CCACHE=y" >> .config
          
          make defconfig
          
          echo "✓ Configuration prepared"

      # ===================================
      # 6. DOWNLOAD SOURCES
      # ===================================
      
      - name: Download sources
        run: |
          cd openwrt
          
          echo "=== Downloading Sources ==="
          
          CORES=$(nproc)
          DOWNLOAD_JOBS=$((CORES * 2))
          echo "Using $DOWNLOAD_JOBS parallel jobs ($CORES cores available)"
          
          # Attempt 1: Parallel with 2x cores
          if ! make download -j${DOWNLOAD_JOBS} V=s; then
            echo "::warning::Parallel download failed, retrying with reduced parallelism"
            sleep 5
            
            # Attempt 2: Parallel with 1x cores
            if ! make download -j${CORES} V=s; then
              echo "::warning::Reduced parallel download failed, trying sequential"
              sleep 10
              
              # Attempt 3: Sequential
              if ! make download -j1 V=sc; then
                echo "::error::All download attempts failed"
                make download -j1 V=s 2>&1 | grep -E '(ERROR|Download failed)' || true
                exit 1
              fi
            fi
          fi
          
          echo "✓ All sources downloaded"
          du -sh dl/ || true

      # ===================================
      # 7. BUILD FIRMWARE
      # ===================================
      
      - name: Build firmware
        env:
          CCACHE_DIR: ${{ github.workspace }}/../.ccache
          FORCE_UNSAFE_CONFIGURE: 1
        run: |
          cd openwrt
          
          echo "=== Pre-build Status ==="
          echo "Disk space:" && df -h . | tail -1
          echo "Memory:" && free -h 2>/dev/null || true
          echo "CPU cores: $(nproc)"
          
          # Check minimum disk space (20GB для AX80 - больше из-за размера образа)
          AVAILABLE_KB=$(df --output=avail . | tail -1)
          if [ "$AVAILABLE_KB" -lt 20971520 ]; then
            echo "::warning::Low disk space: $(($AVAILABLE_KB / 1024 / 1024))GB available"
          fi
          
          CORES=$(nproc)
          BUILD_JOBS=$((CORES + 1))
          
          echo ""
          echo "=== Starting Build ==="
          echo "Build jobs: $BUILD_JOBS"
          echo "CCACHE: $CCACHE_DIR"
          echo ""
          
          # Для AX80 может потребоваться больше памяти, регулируем параллелизм
          MEM_GB=$(free -g 2>/dev/null | awk 'NR==2{print $2}' || echo 16)
          if [ "$MEM_GB" -lt 16 ]; then
            echo "Low memory detected (${MEM_GB}GB), reducing build parallelism"
            BUILD_JOBS=$((CORES / 2 + 1))
          fi
          
          # Attempt 1: Parallel build
          if ! make -j${BUILD_JOBS} V=w; then
            echo "::warning::Parallel build failed, analyzing error"
            df -h . | tail -1
            
            # Free up space
            echo "Cleaning temporary files..."
            rm -rf build_dir/target-*/root-* build_dir/target-*/linux-*/tmp/ 2>/dev/null || true
            
            # Attempt 2: Reduced parallelism
            REDUCED_JOBS=$((BUILD_JOBS / 2))
            echo "Retrying with $REDUCED_JOBS jobs..."
            if ! make -j${REDUCED_JOBS} V=w; then
              echo "::error::Reduced parallel build failed, trying single-threaded"
              
              # Attempt 3: Single-threaded with full verbosity
              if ! make -j1 V=sc; then
                echo "::error::Build failed completely"
                echo "=== Build Log Tail ==="
                tail -100 logs/* 2>/dev/null || true
                exit 1
              fi
            fi
          fi
          
          echo ""
          echo "=== Build Complete ==="
          echo "Final disk:" && df -h . | tail -1
          echo "Artifacts:" && du -sh bin/ 2>/dev/null || true

      # ===================================
      # 8. COLLECT ARTIFACTS
      # ===================================
      
      - name: Collect firmware artifacts
        run: |
          cd openwrt
          
          echo "=== Collecting Artifacts ==="
          
          ART_DIR="artifacts/ax80-v1"
          mkdir -p "$ART_DIR"
          
          # Copy configuration
          cp .config "$ART_DIR/full.config"
          
          # Find and copy firmware files
          FIRMWARE_COUNT=0
          while IFS= read -r -d '' file; do
            cp "$file" "$ART_DIR/"
            FIRMWARE_COUNT=$((FIRMWARE_COUNT + 1))
          done < <(find bin -type f \( -name 'openwrt-*-sysupgrade.bin' -o -name 'openwrt-*-factory.bin' -o -name 'openwrt-*-initramfs-kernel.bin' -o -name 'config.buildinfo' -o -name 'sha256sums' \) -print0)
          
          if [ $FIRMWARE_COUNT -eq 0 ]; then
            echo "::error::No firmware files found"
            find bin -type f -name '*.bin' -o -name '*.img' || true
            exit 1
          fi
          
          # Generate checksums
          if ls "$ART_DIR"/openwrt-*.bin >/dev/null 2>&1; then
            (cd "$ART_DIR" && sha256sum openwrt-*.bin > sha256sums.txt)
            echo "✓ Checksums generated"
          fi
          
          # Create build info
          {
            echo "=== Build Information ==="
            echo "Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Repository: ${{ github.repository }}"
            echo "Commit: ${{ github.sha }}"
            echo "Workflow: ${{ github.workflow }}"
            echo "Runner: $(uname -n)"
            echo "Target: TP-Link Archer AX80 V1"
            echo "Architecture: arm_cortex-a53"
            echo ""
            echo "=== Firmware Files ==="
            ls -lh "$ART_DIR"/*.bin 2>/dev/null || true
          } > "$ART_DIR/build-info.txt"
          
          echo "=== Artifacts Summary ==="
          cat "$ART_DIR/build-info.txt"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_PREFIX }}-firmware
          path: openwrt/artifacts/ax80-v1
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      # ===================================
      # 9. CREATE RELEASE
      # ===================================
      
      - name: Prepare release notes
        id: meta
        run: |
          tag="${{ env.RELEASE_PREFIX }}-$(date +%Y%m%d-%H%M)"
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"
          echo "release_name=TP-Link AX80 V1 firmware ($tag)" >> "$GITHUB_OUTPUT"
          
          cat > release-notes.md << 'EOF'
          ### Target Device
          - **Model:** TP-Link Archer AX80 V1
          - **Architecture:** ARM Cortex-A53
          - **Config:** `ax80-v1.config`
          
          ### Upstream Source
          - **Repository:** https://github.com/${{ env.REMOTE_REPOSITORY }}
          - **Ref:** ${{ steps.upstream.outputs.ref }}
          - **Commit:** ${{ steps.upstream.outputs.commit }}
          
          ### Installation Notes
          - **Factory image:** Use for initial installation from stock firmware
          - **Sysupgrade image:** Use for upgrading existing OpenWrt
          - **Initramfs image:** For recovery/testing (does not persist)
          
          ### Device Features
          - Dual-band Wi-Fi 6 (802.11ax)
          - 1.8 GHz quad-core CPU
          - 512MB RAM
          - 128MB NOR Flash
          - 5x Gigabit Ethernet ports
          - USB 3.0 port
          
          ### Firmware Features
          - OpenSSH with hardened configuration
          - WireGuard VPN support
          - Policy-Based Routing (PBR)
          - AdBlock Fast
          - CAKE QoS support
          - LuCI web interface with HTTPS
          - Wi-Fi 6 (802.11ax) support
          
          ### Build Info
          - Built from: https://github.com/${{ github.repository }}
          - Commit: ${{ github.sha }}
          - Architecture: arm_cortex-a53
          EOF

      - name: Publish release
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: ${{ steps.meta.outputs.release_tag }}
          name: ${{ steps.meta.outputs.release_name }}
          bodyFile: release-notes.md
          artifacts: openwrt/artifacts/ax80-v1/*
          replacesArtifacts: true
          makeLatest: false

      # ===================================
      # 10. CLEANUP
      # ===================================
      
      - name: Cleanup build directory
        if: always()
        run: |
          echo "=== Cleanup ==="
          
          if [ ! -d openwrt ]; then
            echo "No openwrt directory to clean"
            exit 0
          fi
          
          cd openwrt
          
          echo "Before cleanup:"
          df -h . | tail -1
          
          # Remove temporary files but preserve caches
          rm -rf build_dir/target-*/root-* 2>/dev/null || true
          rm -rf build_dir/target-*/linux-*/tmp/ 2>/dev/null || true
          rm -rf tmp/ logs/ 2>/dev/null || true
          
          # Clean staging except toolchain (cached separately)
          find staging_dir -mindepth 1 -maxdepth 1 ! -name 'toolchain-*' -exec rm -rf {} + 2>/dev/null || true
          
          # Clean package build dirs but keep dl/ cache
          find build_dir -type d -name 'ipkg-*' -exec rm -rf {} + 2>/dev/null || true
          
          echo "After cleanup:"
          df -h . | tail -1
          
          echo "✓ Cleanup complete"
