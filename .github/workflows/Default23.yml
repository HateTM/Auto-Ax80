name: Build OpenWrt for TP-Link AX80 V1 (GitHub Hosted)

permissions:
  contents: write
  actions: read

on:
  push:
    branches:
      - main
    paths:
      - "*.config"
      - "files/**"
      - ".github/workflows/build-openwrt.yaml"
  workflow_dispatch:
    inputs:
      remote_ref:
        description: "Override upstream ref (optional)"
        required: false
        default: ""
      test_pr:
        description: "Test specific PR number (e.g., 19440)"
        required: false
        default: ""
  schedule:
    - cron: "38 1 * * *"

concurrency:
  group: openwrt-build-${{ github.ref }}-${{ github.event.inputs.test_pr || 'main' }}
  cancel-in-progress: true

env:
  DL_CACHE_VERSION: v1
  ARTIFACT_RETENTION_DAYS: 7
  CONFIG_FILE: ax80-v1.config
  REMOTE_REPOSITORY: openwrt/openwrt
  REMOTE_REF: main
  RELEASE_PREFIX: ax80-v1
  ARTIFACT_PREFIX: ax80-v1

jobs:
  build:
    name: Build TP-Link AX80 V1 Firmware
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      # ===================================
      # 1. ОЧИСТКА И ПОДГОТОВКА СИСТЕМЫ
      # ===================================
      
      - name: Free up disk space
        run: |
          echo "=== Освобождение дискового пространства ==="
          df -h
          
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo apt-get clean
          
          echo "После очистки:"
          df -h

      - name: Checkout builder repository
        uses: actions/checkout@v4
        with:
          path: builder

      - name: Install build dependencies
        run: |
          echo "=== Установка зависимостей ==="
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            clang \
            flex \
            bison \
            g++ \
            gawk \
            gettext \
            git \
            libncurses-dev \
            libssl-dev \
            python3 \
            python3-setuptools \
            rsync \
            swig \
            unzip \
            zlib1g-dev \
            file \
            wget \
            ccache \
            libelf-dev \
            upx-ucl

      # ===================================
      # 2. ПОЛУЧЕНИЕ ИСХОДНОГО КОДА OPENWRT
      # ===================================
      
      - name: Fetch upstream OpenWrt source
        id: upstream
        run: |
          set -euo pipefail
          
          echo "=== Получение исходного кода OpenWrt ==="
          
          # Используем shallow clone для экономии места
          REF="${{ env.REMOTE_REF }}"
          if [ -n "${{ github.event.inputs.remote_ref }}" ]; then
            REF="${{ github.event.inputs.remote_ref }}"
          fi
          
          echo "Клонируем OpenWrt (ветка: $REF)"
          git clone --depth=1 --filter=blob:none --single-branch \
            --branch "$REF" \
            https://github.com/${{ env.REMOTE_REPOSITORY }}.git openwrt
          
          cd openwrt
          
          # Если указан PR для тестирования - мержим его
          if [ -n "${{ github.event.inputs.test_pr }}" ]; then
            PR_NUMBER="${{ github.event.inputs.test_pr }}"
            echo "=== Тестируем PR #$PR_NUMBER ==="
            
            # Получаем и мержим PR
            git fetch origin "pull/$PR_NUMBER/head:pr-$PR_NUMBER"
            git checkout "pr-$PR_NUMBER"
            
            # Получаем информацию о PR
            PR_INFO=$(curl -s "https://api.github.com/repos/${{ env.REMOTE_REPOSITORY }}/pulls/$PR_NUMBER")
            PR_TITLE=$(echo "$PR_INFO" | grep '"title":' | head -1 | cut -d'"' -f4)
            PR_AUTHOR=$(echo "$PR_INFO" | grep '"login":' | head -1 | cut -d'"' -f4)
            
            echo "PR Title: $PR_TITLE"
            echo "PR Author: $PR_AUTHOR"
            echo "PR Branch: pr-$PR_NUMBER"
            
            # Обновляем вывод с информацией о PR
            echo "ref=$REF" >> "$GITHUB_OUTPUT"
            echo "commit=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
            echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
            echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            echo "pr_title=$PR_TITLE" >> "$GITHUB_OUTPUT"
            echo "pr_author=$PR_AUTHOR" >> "$GITHUB_OUTPUT"
          else
            # Стандартная информация о коммите
            echo "ref=$REF" >> "$GITHUB_OUTPUT"
            echo "commit=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
            echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
            echo "pr_number=" >> "$GITHUB_OUTPUT"
            echo "pr_title=" >> "$GITHUB_OUTPUT"
            echo "pr_author=" >> "$GITHUB_OUTPUT"
          fi
          
          echo "✓ Исходный код получен: $(git rev-parse --short HEAD)"
          du -sh .

      # ===================================
      # 3. КЭШИРОВАНИЕ (С УЧЕТОМ PR)
      # ===================================
      
      - name: Restore feeds cache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/feeds
            openwrt/.feeds_updated
          key: feeds-${{ runner.os }}-${{ hashFiles('openwrt/feeds.conf.default') }}-${{ github.sha }}-${{ steps.upstream.outputs.pr_number || 'main' }}
          restore-keys: |
            feeds-${{ runner.os }}-${{ hashFiles('openwrt/feeds.conf.default') }}-
            feeds-${{ runner.os }}-

      - name: Restore downloads cache
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: openwrt-dl-${{ runner.os }}-${{ env.DL_CACHE_VERSION }}-${{ hashFiles('builder/ax80-v1.config') }}-${{ steps.upstream.outputs.pr_number || 'main' }}
          restore-keys: |
            openwrt-dl-${{ runner.os }}-${{ env.DL_CACHE_VERSION }}-
            openwrt-dl-${{ runner.os }}-

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-ax80-v1-${{ github.sha }}-${{ steps.upstream.outputs.pr_number || 'main' }}
          restore-keys: |
            ccache-${{ runner.os }}-ax80-v1-

      - name: Restore toolchain cache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: toolchain-${{ runner.os }}-ax80-v1-${{ hashFiles('builder/ax80-v1.config') }}-${{ steps.upstream.outputs.pr_number || 'main' }}
          restore-keys: |
            toolchain-${{ runner.os }}-ax80-v1-

      # ===================================
      # 4. ОБНОВЛЕНИЕ FEEDS
      # ===================================
      
      - name: Update and install feeds
        run: |
          cd openwrt
          
          echo "=== Обновление feeds ==="

          # Configure git for better reliability
          git config --global http.postBuffer 1048576000
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 300
          git config --global core.compression 0
          git config --global protocol.version 2
          
          echo "Диск перед обновлением:"
          df -h .
          
          # Быстрое обновление если есть кэш
          if [ -f .feeds_updated ]; then
            echo "Используем кэшированные feeds, быстрое обновление..."
            if ! timeout 300 ./scripts/feeds update -a; then
              echo "::warning::Быстрое обновление не удалось, пробуем полное..."
              rm -f .feeds_updated
            fi
          fi
          
          if [ ! -f .feeds_updated ]; then
            echo "Полное обновление feeds..."
            
            # Простое обновление feeds с обработкой ошибок
            for attempt in {1..3}; do
              echo "Попытка обновления $attempt/3"
              
              if ./scripts/feeds update -a; then
                touch .feeds_updated
                echo "✓ Feeds обновлены успешно"
                break
              elif [ $attempt -eq 3 ]; then
                echo "::error::Не удалось обновить feeds после 3 попыток"
                exit 1
              fi
              
              sleep 10
            done
          fi
          
          echo "=== Установка feeds ==="
          # Установка feeds с обработкой ошибок
          for attempt in {1..2}; do
            if ./scripts/feeds install -a; then
              echo "✓ Feeds установлены успешно"
              break
            elif [ $attempt -eq 2 ]; then
              echo "::error::Не удалось установить feeds"
              exit 1
            else
              echo "Повторная попытка установки feeds..."
              sleep 5
            fi
          done
          
          echo "Диск после обновления:"
          df -h .

      # ===================================
      # 5. КОНФИГУРАЦИЯ СБОРКИ
      # ===================================
      
      - name: Prepare configuration
        run: |
          cd openwrt
          
          echo "=== Подготовка конфигурации ==="
          
          mkdir -p files
          cp -a ../builder/files/. ./files/
          
          # Update upgrade script with repository info
          if [ -f ./files/usr/bin/upgrade_custom_openwrt ]; then
            sed -i "s|XXXXXX/XXXXXX|${{ github.repository }}|" ./files/usr/bin/upgrade_custom_openwrt || true
            chmod 755 ./files/usr/bin/upgrade_custom_openwrt
            echo "✓ Updated upgrade script"
          fi
          
          # Копируем конфиг
          cp "../builder/${{ env.CONFIG_FILE }}" .config
          
          # Добавляем оптимизации
          echo "CONFIG_CCACHE=y" >> .config
          echo "CONFIG_BUILD_LOG=y" >> .config
          
          # Минимальная конфигурация
          make defconfig
          
          echo "✓ Конфигурация готова"

      # ===================================
      # 6. ЗАГРУЗКА ИСХОДНИКОВ
      # ===================================
      
      - name: Download sources
        run: |
          cd openwrt
          
          echo "=== Downloading Sources ==="
          
          CORES=$(nproc)
          DOWNLOAD_JOBS=$((CORES * 2))
          echo "Using $DOWNLOAD_JOBS parallel jobs ($CORES cores available)"
          
          # Attempt 1: Parallel with 2x cores
          if ! make download -j${DOWNLOAD_JOBS} V=s; then
            echo "::warning::Parallel download failed, retrying with reduced parallelism"
            sleep 5
            
            # Attempt 2: Parallel with 1x cores
            if ! make download -j${CORES} V=s; then
              echo "::warning::Reduced parallel download failed, trying sequential"
              sleep 10
              
              # Attempt 3: Sequential
              if ! make download -j1 V=sc; then
                echo "::error::All download attempts failed"
                make download -j1 V=s 2>&1 | grep -E '(ERROR|Download failed)' || true
                exit 1
              fi
            fi
          fi
          
          echo "Размер dl директории:"
          du -sh dl/ || true
          echo "Диск после загрузки:"
          df -h .

      # ===================================
      # 7. СБОРКА ПРОШИВКИ
      # ===================================
      
      - name: Build firmware
        env:
          CCACHE_DIR: ~/.ccache
          FORCE_UNSAFE_CONFIGURE: 1
        run: |
          cd openwrt
          
          echo "=== Старт сборки ==="
          echo "Доступные ресурсы:"
          df -h .
          echo "Ядер: $(nproc)"
          free -h
          
          CORES=$(nproc)
          BUILD_JOBS=$((CORES + 1))
          
          echo ""
          echo "=== Starting Build ==="
          echo "Build jobs: $BUILD_JOBS"
          echo "CCACHE: $CCACHE_DIR"
          echo ""
          
          # Attempt 1: Parallel build
          if ! make -j${BUILD_JOBS} V=w; then
            echo "::warning::Parallel build failed, analyzing error"
            df -h . | tail -1
            
            # Free up space
            echo "Cleaning temporary files..."
            rm -rf build_dir/target-*/root-* build_dir/target-*/linux-*/tmp/ 2>/dev/null || true
            
            # Attempt 2: Reduced parallelism
            echo "Retrying with $CORES jobs..."
            if ! make -j${CORES} V=w; then
              echo "::error::Reduced parallel build failed, trying single-threaded"
              
              # Attempt 3: Single-threaded with full verbosity
              if ! make -j1 V=sc; then
                echo "::error::Build failed completely"
                echo "=== Build Log Tail ==="
                tail -100 logs/* 2>/dev/null || true
                exit 1
              fi
            fi
          fi
          
          echo ""
          echo "=== Build Complete ==="
          echo "Final disk:" && df -h . | tail -1
          echo "Artifacts:" && du -sh bin/ 2>/dev/null || true

      # ===================================
      # 8. СОБИРАЕМ АРТЕФАКТЫ
      # ===================================
      
      - name: Collect firmware artifacts
        id: collect_artifacts
        run: |
          cd openwrt
          
          echo "=== Сбор артефактов ==="
          
          # Определяем имя директории на основе PR
          if [ -n "${{ steps.upstream.outputs.pr_number }}" ]; then
            ART_DIR="artifacts/ax80-v1-pr-${{ steps.upstream.outputs.pr_number }}"
            ARTIFACT_NAME="ax80-v1-pr-${{ steps.upstream.outputs.pr_number }}-firmware"
            ARTIFACT_PATH="openwrt/artifacts/ax80-v1-pr-${{ steps.upstream.outputs.pr_number }}"
          else
            ART_DIR="artifacts/ax80-v1"
            ARTIFACT_NAME="ax80-v1-firmware"
            ARTIFACT_PATH="openwrt/artifacts/ax80-v1"
          fi
          
          mkdir -p "$ART_DIR"
          
          echo "=== Поиск файлов прошивок ==="
          
          # Ищем файлы прошивок с разными расширениями
          FIRMWARE_PATTERNS=(
            "*-sysupgrade.bin"
            "*-factory.bin" 
            "*-initramfs-kernel.bin"
            "*-squashfs-sysupgrade.bin"
            "*-squashfs-factory.bin"
            "*-combined-squashfs.img"
            "*-rootfs-squashfs.img"
            "*-kernel.bin"
            "*.itb"           # FIT Images (Flattened Image Tree)
            "*.img"           # Образы
            "*.bin"           # Бинарные файлы
            "*.trx"           # TRX форматы
            "*.chk"           # CHK форматы
            "*.ubi"           # UBI образы
            "*.ubifs"         # UBIFS образы
            "*.tar"           # Tar архивы
            "*.gz"            # Сжатые файлы
            "*.bz2"           # Сжатые файлы
            "*.xz"            # Сжатые файлы
          )
          
          FIRMWARE_COUNT=0
          for pattern in "${FIRMWARE_PATTERNS[@]}"; do
            echo "Поиск по шаблону: $pattern"
            while IFS= read -r -d '' file; do
              if [ -f "$file" ]; then
                echo "Найдено: $file"
                cp "$file" "$ART_DIR/"
                FIRMWARE_COUNT=$((FIRMWARE_COUNT + 1))
              fi
            done < <(find bin/targets -type f -name "$pattern" -print0 2>/dev/null || true)
          done
          
          # Специальный поиск для FIT образов (часто имеют сложные имена)
          echo "=== Специальный поиск FIT образов ==="
          while IFS= read -r -d '' file; do
            if [ -f "$file" ]; then
              # Проверяем что это FIT образ
              if file "$file" | grep -q -E "(Flattened Image Tree|FIT|Device Tree Blob)"; then
                echo "Найден FIT образ: $file"
                cp "$file" "$ART_DIR/"
                FIRMWARE_COUNT=$((FIRMWARE_COUNT + 1))
              fi
            fi
          done < <(find bin/targets -type f -size +1M -print0 2>/dev/null || true)
          
          if [ $FIRMWARE_COUNT -eq 0 ]; then
            echo "::warning::Файлы прошивок не найдены стандартными шаблонами"
            echo "=== Расширенный поиск ==="
            
            # Ищем любые бинарные файлы в targets
            echo "=== Поиск бинарных файлов ==="
            find bin/targets -type f -size +1M -exec file {} \; | grep -E '(firmware|data|binary|FIT|Flattened Image Tree)' || true
            
            # Копируем все большие файлы из targets (кроме явно не прошивок)
            echo "=== Копирование больших файлов ==="
            while IFS= read -r -d '' file; do
              if [ -f "$file" ]; then
                # Исключаем некоторые типы файлов
                if [[ "$file" != *".json" ]] && \
                   [[ "$file" != *".txt" ]] && \
                   [[ "$file" != *".log" ]] && \
                   [[ "$file" != *".md" ]]; then
                  echo "Копируем: $file"
                  cp "$file" "$ART_DIR/"
                  FIRMWARE_COUNT=$((FIRMWARE_COUNT + 1))
                fi
              fi
            done < <(find bin/targets -type f -size +1M -print0 2>/dev/null || true)
            
            # Пересчитываем
            FIRMWARE_COUNT=$(find "$ART_DIR" -type f | wc -l)
          fi
          
          echo "Найдено файлов прошивок: $FIRMWARE_COUNT"
          
          # Копируем дополнительные файлы
          echo "=== Копирование дополнительных файлов ==="
          cp .config "$ART_DIR/full.config" 2>/dev/null || echo "Конфиг не скопирован"
          
          # Копируем информационные файлы
          INFO_FILES=(
            "sha256sums"
            "*.buildinfo"
            "*.manifest"
            "version.buildinfo"
            "profiles.json"
            "config.seed"
            "feeds.buildinfo"
          )
          
          for pattern in "${INFO_FILES[@]}"; do
            find bin -type f -name "$pattern" -exec cp {} "$ART_DIR/" \; 2>/dev/null || true
          done
          
          # Генерируем checksums если есть файлы прошивок
          if [ $FIRMWARE_COUNT -gt 0 ]; then
            echo "=== Генерация checksums ==="
            (cd "$ART_DIR" && sha256sum * > sha256sums.txt 2>/dev/null || true)
            echo "✓ Checksums сгенерированы для $FIRMWARE_COUNT файлов"
            
            # Дополнительная информация о FIT образах
            if find "$ART_DIR" -name "*.itb" | grep -q .; then
              echo "=== Информация о FIT образах ==="
              for itb_file in "$ART_DIR"/*.itb; do
                if [ -f "$itb_file" ]; then
                  echo "FIT образ: $(basename "$itb_file")"
                  # Пытаемся получить информацию о FIT образе
                  if command -v dumpimage >/dev/null 2>&1; then
                    dumpimage -l "$itb_file" 2>/dev/null | head -10 || true
                  fi
                fi
              done
            fi
          else
            echo "::warning::Не найдено ни одного файла прошивки"
          fi
          
          # Создаем список файлов для отладки
          echo "=== Содержимое bin директории ==="
          find bin -type f -name '*' -exec ls -la {} \; 2>/dev/null | head -30 || true
          
          # Информация о сборке
          {
            echo "=== Build Information ==="
            echo "Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "Repository: ${{ github.repository }}"
            echo "Commit: ${{ github.sha }}"
            echo "OpenWrt: ${{ steps.upstream.outputs.ref }}@${{ steps.upstream.outputs.short }}"
            if [ -n "${{ steps.upstream.outputs.pr_number }}" ]; then
              echo "PR: #${{ steps.upstream.outputs.pr_number }} - ${{ steps.upstream.outputs.pr_title }}"
              echo "PR Author: ${{ steps.upstream.outputs.pr_author }}"
            fi
            echo ""
            echo "=== Firmware Files ($FIRMWARE_COUNT found) ==="
            find "$ART_DIR" -type f -exec ls -la {} \; 2>/dev/null || echo "No files found"
            echo ""
            echo "=== File Types ==="
            find "$ART_DIR" -type f -exec file {} \; 2>/dev/null || true
            echo ""
            echo "=== Directory Structure ==="
            find bin/targets -type d 2>/dev/null | head -15 || true
          } > "$ART_DIR/build-info.txt"
          
          echo "=== Итоговые артефакты ==="
          ls -la "$ART_DIR/" 2>/dev/null || echo "Артефакты не созданы"
          
          # Сохраняем имена для следующего шага
          echo "artifact_name=$ARTIFACT_NAME" >> "$GITHUB_OUTPUT"
          echo "artifact_path=$ARTIFACT_PATH" >> "$GITHUB_OUTPUT"
          echo "firmware_count=$FIRMWARE_COUNT" >> "$GITHUB_OUTPUT"

      - name: Upload firmware artifact
        if: steps.collect_artifacts.outputs.firmware_count != '0'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.collect_artifacts.outputs.artifact_name }}
          path: ${{ steps.collect_artifacts.outputs.artifact_path }}
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          compression-level: 9

      - name: Warn if no firmware found
        if: steps.collect_artifacts.outputs.firmware_count == '0'
        run: |
          echo "::warning::Не найдено ни одного файла прошивки!"
          echo "Проверьте логи сборки и конфигурацию устройства."
          echo "Содержимое bin директории:"
          find openwrt/bin -type f -name '*' 2>/dev/null | head -30 || true
          echo "Структура targets:"
          find openwrt/bin/targets -type d 2>/dev/null || true

      # ===================================
      # 9. СОЗДАНИЕ РЕЛИЗА
      # ===================================
      
      - name: Prepare release
        if: (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && success()
        id: release
        run: |
          if [ -n "${{ steps.upstream.outputs.pr_number }}" ]; then
            tag="${{ env.RELEASE_PREFIX }}-pr-${{ steps.upstream.outputs.pr_number }}-$(date +%Y%m%d)"
            name="AX80 V1 PR ${{ steps.upstream.outputs.pr_number }} Build $(date +%Y%m%d)"
          else
            tag="${{ env.RELEASE_PREFIX }}-$(date +%Y%m%d)"
            name="AX80 V1 Build $(date +%Y%m%d)"
          fi
          
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"
          echo "release_name=$name" >> "$GITHUB_OUTPUT"
          
          # Создаем описание релиза
          if [ -n "${{ steps.upstream.outputs.pr_number }}" ]; then
            cat > release-info.md << EOF
          ### TP-Link Archer AX80 V1 - OpenWrt Build with PR #${{ steps.upstream.outputs.pr_number }}
          
          **PR Title:** ${{ steps.upstream.outputs.pr_title }}
          **PR Author:** ${{ steps.upstream.outputs.pr_author }}
          **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          **Source:** ${{ env.REMOTE_REPOSITORY }}@${{ steps.upstream.outputs.ref }}
          **Commit:** ${{ steps.upstream.outputs.short }}
          
          **Installation:**
          - \`factory.bin\` - для установки из stock прошивки
          - \`sysupgrade.bin\` - для обновления существующего OpenWrt
          
          **⚠️  Это тестовая сборка с PR!**
          Используйте с осторожностью, возможны нестабильности.
          
          Built via GitHub Actions
          EOF
          else
            cat > release-info.md << EOF
          ### TP-Link Archer AX80 V1 - OpenWrt Build
          
          **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Source:** ${{ env.REMOTE_REPOSITORY }}@${{ steps.upstream.outputs.ref }}
          **Commit:** ${{ steps.upstream.outputs.short }}
          
          **Installation:**
          - \`factory.bin\` - для установки из stock прошивки
          - \`sysupgrade.bin\` - для обновления существующего OpenWrt
          
          **Features:**
          - Wi-Fi 6 (802.11ax) support
          - LuCI web interface
          - WireGuard VPN
          - SQM QoS
          
          Built via GitHub Actions
          EOF
          fi

      - name: Create release
        if: (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release.outputs.release_tag }}
          name: ${{ steps.release.outputs.release_name }}
          body_path: release-info.md
          files: openwrt/artifacts/ax80-v1${{ steps.upstream.outputs.pr_number && format('-pr-{0}', steps.upstream.outputs.pr_number) || '' }}/*
          draft: false
          prerelease: ${{ steps.upstream.outputs.pr_number != '' }}

      # ===================================
      # 10. ФИНАЛЬНАЯ СТАТИСТИКА
      # ===================================
      
      - name: Cleanup build directory
        if: always()
        run: |
          echo "=== Cleanup ==="
          
          if [ ! -d openwrt ]; then
            echo "No openwrt directory to clean"
            exit 0
          fi
          
          cd openwrt
          
          echo "Before cleanup:"
          df -h . | tail -1
          
          # Remove temporary files but preserve caches
          rm -rf build_dir/target-*/root-* 2>/dev/null || true
          rm -rf build_dir/target-*/linux-*/tmp/ 2>/dev/null || true
          rm -rf tmp/ logs/ 2>/dev/null || true
          
          # Clean staging except toolchain (cached separately)
          find staging_dir -mindepth 1 -maxdepth 1 ! -name 'toolchain-*' -exec rm -rf {} + 2>/dev/null || true
          
          # Clean package build dirs but keep dl/ cache
          find build_dir -type d -name 'ipkg-*' -exec rm -rf {} + 2>/dev/null || true
          
          echo "After cleanup:"
          df -h . | tail -1
          
          echo "✓ Cleanup complete"
