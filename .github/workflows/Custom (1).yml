name: Build OpenWrt Snapshot from PR

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Номер PR из репозитория openwrt/openwrt (обязательно)'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      OPENWRT_REPO: "https://git.openwrt.org/openwrt/openwrt.git"

    steps:
    - name: Checkout OpenWrt Repository
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        path: openwrt
        fetch-depth: 0

    - name: Set up Git
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Fetch and Checkout PR
      run: |
        cd openwrt
        git fetch origin pull/${{ inputs.pr_number }}/head:pr-${{ inputs.pr_number }}
        git checkout pr-${{ inputs.pr_number }}

    - name: Update and Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Download build.config via API
      run: |
          curl -sL https://raw.githubusercontent.com/HateTM/Auto-Ax80/main/build.config -o openwrt/.config

    - name: Setup Build Configuration
      run: |
        cd openwrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Build OpenWrt
      run: |
        cd openwrt
        make -j$(nproc) V=s

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-pr-${{ inputs.pr_number }}-build-${{ github.run_id }}
        path: openwrt/bin/targets/

    - name: Cache Ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-
